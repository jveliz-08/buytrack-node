<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Presupuestos</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/advanced-modules.css">
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-building"></i>
                    <h1>Gestión de Compras</h1>
                </div>
                <nav class="nav">
                    <a href="/" class="nav-link">
                        <i class="fas fa-home"></i> <span>Inicio</span>
                    </a>
                    <a href="/control-panel" class="nav-link">
                        <i class="fas fa-chart-pie"></i> <span>Panel</span>
                    </a>
                    <a href="/budgets-advanced" class="nav-link active">
                        <i class="fas fa-coins"></i> <span>Presupuestos</span>
                    </a>
                    <a href="/cost-centers-advanced" class="nav-link">
                        <i class="fas fa-diagram-project"></i> <span>Centros</span>
                    </a>
                    <a href="/orders" class="nav-link">
                        <i class="fas fa-file-invoice"></i> <span>Órdenes</span>
                    </a>
                    <a href="/suppliers" class="nav-link">
                        <i class="fas fa-building"></i> <span>Proveedores</span>
                    </a>
                </nav>
                <div class="header-actions">
                    <div class="user-info">
                        <i class="fas fa-user"></i>
                        <span id="user-name">Usuario</span>
                    </div>
                    <button class="btn-logout" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Salir</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Advanced Page Header -->
        <section class="advanced-page-header">
            <div class="page-header-content">
                <div class="page-title-section">
                    <h1><i class="fas fa-coins"></i> Gestión de Presupuestos</h1>
                    <p class="page-subtitle">Control integral de presupuestos con análisis predictivo y optimización de recursos</p>
                    <div class="breadcrumb">
                        <span>Sistema</span> <i class="fas fa-chevron-right"></i> 
                        <span>Finanzas</span> <i class="fas fa-chevron-right"></i> 
                        <span class="active">Presupuestos</span>
                    </div>
                </div>
                <div class="page-actions-advanced">
                    <div class="quick-actions">
                        <button class="btn-ghost" onclick="generateForecast()" title="Generar Pronóstico">
                            <i class="fas fa-crystal-ball"></i>
                        </button>
                        <button class="btn-ghost" onclick="exportBudgetReport()" title="Exportar Reporte">
                            <i class="fas fa-file-export"></i>
                        </button>
                        <button class="btn-ghost" onclick="importBudgets()" title="Importar Presupuestos">
                            <i class="fas fa-file-import"></i>
                        </button>
                        <button class="btn-ghost" onclick="refreshBudgetData()" title="Actualizar">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="primary-actions">
                        <button class="btn-secondary" onclick="openBulkUpdateModal()">
                            <i class="fas fa-edit"></i>
                            <span>Actualización Masiva</span>
                        </button>
                        <button id="btn-new-budget" class="btn-primary-large" onclick="openCreateBudgetModal()">
                            <i class="fas fa-plus"></i>
                            <span>Nuevo Presupuesto</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Executive Summary Dashboard -->
        <section class="executive-dashboard">
            <div class="dashboard-grid">
                <div class="executive-card total">
                    <div class="card-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="card-content">
                        <h3>Presupuesto Total</h3>
                        <div class="big-number" id="total-budget-amount">$0</div>
                        <div class="card-details">
                            <span class="detail-item">
                                <i class="fas fa-calendar"></i>
                                <span id="current-period">2024-01</span>
                            </span>
                            <span class="detail-item">
                                <i class="fas fa-building"></i>
                                <span id="centers-count">0 centros</span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="executive-card spent">
                    <div class="card-icon">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <div class="card-content">
                        <h3>Total Ejecutado</h3>
                        <div class="big-number" id="total-spent">$0</div>
                        <div class="card-metric">
                            <div class="metric-bar">
                                <div class="metric-fill spent" id="spent-fill"></div>
                            </div>
                            <span class="metric-percentage" id="spent-percentage">0%</span>
                        </div>
                    </div>
                </div>

                <div class="executive-card available">
                    <div class="card-icon">
                        <i class="fas fa-piggy-bank"></i>
                    </div>
                    <div class="card-content">
                        <h3>Disponible</h3>
                        <div class="big-number" id="available-budget">$0</div>
                        <div class="card-trend">
                            <span class="trend-indicator" id="availability-trend">
                                <i class="fas fa-arrow-up"></i>
                                <span>+5.2% vs anterior</span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="executive-card alerts">
                    <div class="card-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="card-content">
                        <h3>Alertas Activas</h3>
                        <div class="big-number" id="active-alerts">0</div>
                        <div class="alert-breakdown" id="alert-breakdown">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Period and Filter Controls -->
        <section class="advanced-controls">
            <div class="controls-container">
                <div class="period-control">
                    <h4>Período de Análisis</h4>
                    <div class="period-selector">
                        <button class="period-btn" data-period="previous" onclick="changePeriod('previous')">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="current-period">
                            <input type="month" id="period-input" onchange="changePeriod('custom')">
                            <span class="period-label" id="period-label">Enero 2024</span>
                        </div>
                        <button class="period-btn" data-period="next" onclick="changePeriod('next')">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <div class="filters-control">
                    <h4>Filtros Avanzados</h4>
                    <div class="filters-grid">
                        <div class="filter-item">
                            <select id="currency-filter" onchange="applyFilters()">
                                <option value="">Todas las Monedas</option>
                                <option value="CLP">Pesos Chilenos</option>
                                <option value="USD">Dólares</option>
                                <option value="UF">UF</option>
                            </select>
                        </div>
                        
                        <div class="filter-item">
                            <select id="status-filter" onchange="applyFilters()">
                                <option value="">Todos los Estados</option>
                                <option value="normal">Normal</option>
                                <option value="warning">Advertencia</option>
                                <option value="critical">Crítico</option>
                                <option value="exceeded">Excedido</option>
                            </select>
                        </div>

                        <div class="filter-item">
                            <select id="department-filter" onchange="applyFilters()">
                                <option value="">Todos los Departamentos</option>
                                <!-- Se llena dinámicamente -->
                            </select>
                        </div>

                        <div class="filter-item search-filter">
                            <input type="text" id="search-filter" placeholder="Buscar centro..." 
                                   onkeyup="applyFilters()">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Analytics and Insights Section -->
        <section class="analytics-section">
            <div class="analytics-container">
                <div class="chart-panel large">
                    <div class="chart-header">
                        <h3>Análisis de Tendencias Presupuestarias</h3>
                        <div class="chart-controls">
                            <button class="chart-btn active" data-chart="spending-trend">Tendencia de Gastos</button>
                            <button class="chart-btn" data-chart="budget-distribution">Distribución</button>
                            <button class="chart-btn" data-chart="efficiency">Eficiencia</button>
                            <button class="chart-btn" data-chart="forecast">Pronóstico</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <div class="insights-panel">
                    <h3>Insights y Recomendaciones</h3>
                    <div class="insights-list" id="budget-insights">
                        <!-- Los insights se cargarán dinámicamente -->
                    </div>
                    
                    <div class="quick-stats">
                        <div class="stat-item">
                            <label>Eficiencia Promedio</label>
                            <span class="stat-value" id="avg-efficiency">85%</span>
                        </div>
                        <div class="stat-item">
                            <label>Proyección Mes</label>
                            <span class="stat-value" id="month-projection">$2.4M</span>
                        </div>
                        <div class="stat-item">
                            <label>Ahorro Potencial</label>
                            <span class="stat-value success" id="potential-savings">$150K</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Advanced Budget Table -->
        <section class="data-section">
            <div class="table-container">
                <div class="table-header">
                    <h3>Presupuestos Detallados</h3>
                    <div class="table-actions">
                        <div class="bulk-actions">
                            <select id="bulk-action" disabled>
                                <option>Acciones en lote</option>
                                <option value="approve">Aprobar seleccionados</option>
                                <option value="adjust">Ajustar montos</option>
                                <option value="export">Exportar seleccionados</option>
                                <option value="copy">Copiar a próximo período</option>
                            </select>
                            <button class="btn-secondary" onclick="executeBulkAction()" disabled id="bulk-execute">
                                Ejecutar
                            </button>
                        </div>
                        
                        <div class="view-options">
                            <select id="items-per-page" onchange="changePageSize()">
                                <option value="10">10 por página</option>
                                <option value="25">25 por página</option>
                                <option value="50">50 por página</option>
                                <option value="100">100 por página</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="advanced-table-wrapper">
                    <table class="advanced-table">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="select-all-budgets" onchange="toggleSelectAll()">
                                </th>
                                <th class="sortable" data-sort="center_name">
                                    Centro de Costo <i class="fas fa-sort"></i>
                                </th>
                                <th class="sortable" data-sort="period">
                                    Período <i class="fas fa-sort"></i>
                                </th>
                                <th class="sortable" data-sort="budget_amount">
                                    Presupuesto <i class="fas fa-sort"></i>
                                </th>
                                <th class="sortable" data-sort="spent">
                                    Ejecutado <i class="fas fa-sort"></i>
                                </th>
                                <th>Utilización</th>
                                <th>Disponible</th>
                                <th>Proyección</th>
                                <th>Estado</th>
                                <th>Última Modificación</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="budgets-table-body">
                            <!-- Los datos se cargarán dinámicamente -->
                        </tbody>
                    </table>
                </div>

                <div class="table-footer">
                    <div class="table-summary">
                        <div class="summary-stats">
                            <span class="summary-item">
                                <strong>Total Presupuestado:</strong> 
                                <span id="summary-budgeted">$0</span>
                            </span>
                            <span class="summary-item">
                                <strong>Total Ejecutado:</strong> 
                                <span id="summary-executed">$0</span>
                            </span>
                            <span class="summary-item">
                                <strong>Disponible:</strong> 
                                <span id="summary-available">$0</span>
                            </span>
                        </div>
                    </div>
                    <div class="pagination" id="budget-pagination">
                        <!-- La paginación se generará dinámicamente -->
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Advanced Budget Modal -->
    <div id="budgetModal" class="advanced-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="budget-modal-title">Nuevo Presupuesto</h2>
                <button class="modal-close" onclick="closeBudgetModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="budgetForm" class="advanced-form">
                    <div class="form-tabs">
                        <button type="button" class="tab-btn active" data-tab="basic">Información Básica</button>
                        <button type="button" class="tab-btn" data-tab="details">Detalles</button>
                        <button type="button" class="tab-btn" data-tab="rules">Reglas y Alertas</button>
                    </div>

                    <div class="tab-content">
                        <!-- Basic Information Tab -->
                        <div id="basic-tab" class="tab-panel active">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="budget-cost-center">Centro de Costo *</label>
                                    <select id="budget-cost-center" required>
                                        <option value="">Seleccionar centro...</option>
                                        <!-- Se llena dinámicamente -->
                                    </select>
                                    <small class="form-error" id="err-cost-center" style="display:none">Seleccione un centro</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="budget-period">Período *</label>
                                    <input type="month" id="budget-period" required>
                                    <small class="form-error" id="err-period" style="display:none">Seleccione un período</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="budget-amount">Monto del Presupuesto *</label>
                                    <div class="input-group">
                                        <input type="number" id="budget-amount" required min="0" step="0.01">
                                        <select id="budget-currency" class="input-addon">
                                            <option value="CLP">CLP</option>
                                            <option value="USD">USD</option>
                                            <option value="UF">UF</option>
                                        </select>
                                    </div>
                                    <small class="form-error" id="err-amount" style="display:none">Ingrese un monto válido</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="budget-category">Categoría</label>
                                    <select id="budget-category">
                                        <option value="operational">Operacional</option>
                                        <option value="investment">Inversión</option>
                                        <option value="maintenance">Mantenimiento</option>
                                        <option value="emergency">Emergencia</option>
                                        <option value="other">Otro</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Details Tab -->
                        <div id="details-tab" class="tab-panel">
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label for="budget-description">Descripción y Justificación</label>
                                    <textarea id="budget-description" rows="3" 
                                              placeholder="Describa el propósito y justificación de este presupuesto"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="budget-priority">Prioridad</label>
                                    <select id="budget-priority">
                                        <option value="low">Baja</option>
                                        <option value="medium" selected>Media</option>
                                        <option value="high">Alta</option>
                                        <option value="critical">Crítica</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="budget-approver">Aprobador</label>
                                    <input type="text" id="budget-approver" 
                                           placeholder="Nombre del aprobador">
                                </div>
                                
                                <div class="form-group">
                                    <label for="quarterly-distribution">Distribución Trimestral</label>
                                    <div class="quarterly-inputs">
                                        <input type="number" id="q1-percent" placeholder="Q1 %" min="0" max="100">
                                        <input type="number" id="q2-percent" placeholder="Q2 %" min="0" max="100">
                                        <input type="number" id="q3-percent" placeholder="Q3 %" min="0" max="100">
                                        <input type="number" id="q4-percent" placeholder="Q4 %" min="0" max="100">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rules and Alerts Tab -->
                        <div id="rules-tab" class="tab-panel">
                            <div class="form-section">
                                <h4>Límites y Alertas</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="warning-threshold">Alerta de Advertencia (%)</label>
                                        <input type="number" id="warning-threshold" min="0" max="100" value="80">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="critical-threshold">Alerta Crítica (%)</label>
                                        <input type="number" id="critical-threshold" min="0" max="100" value="95">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="overspend-limit">Límite de Sobregasto (%)</label>
                                        <input type="number" id="overspend-limit" min="0" max="50" value="10">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <h4>Configuraciones</h4>
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="auto-adjust" checked>
                                        <span class="checkmark"></span>
                                        Ajuste automático por inflación
                                    </label>
                                    
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="rollover-unused">
                                        <span class="checkmark"></span>
                                        Transferir saldo no utilizado al próximo período
                                    </label>
                                    
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="require-approval">
                                        <span class="checkmark"></span>
                                        Requiere aprobación para modificaciones
                                    </label>
                                    
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="email-alerts" checked>
                                        <span class="checkmark"></span>
                                        Alertas por correo electrónico
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeBudgetModal()">
                    Cancelar
                </button>
                <button type="button" class="btn-info" onclick="previewBudget()">
                    <i class="fas fa-eye"></i> Vista Previa
                </button>
                <button type="submit" form="budgetForm" class="btn-primary">
                    <i class="fas fa-save"></i> Guardar Presupuesto
                </button>
            </div>
        </div>
    </div>

    <!-- Bulk Update Modal -->
    <div id="bulkUpdateModal" class="advanced-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2>Actualización Masiva de Presupuestos</h2>
                <button class="modal-close" onclick="closeBulkUpdateModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="bulk-options">
                    <div class="option-card">
                        <h4>Ajuste por Inflación</h4>
                        <p>Aplicar un ajuste porcentual a todos los presupuestos seleccionados</p>
                        <div class="form-group">
                            <label>Porcentaje de ajuste:</label>
                            <input type="number" id="inflation-rate" step="0.1" placeholder="Ej: 3.5">
                        </div>
                    </div>
                    
                    <div class="option-card">
                        <h4>Copia a Período Siguiente</h4>
                        <p>Copiar presupuestos al próximo período con ajustes opcionales</p>
                        <div class="form-group">
                            <label>Período destino:</label>
                            <input type="month" id="target-period">
                        </div>
                    </div>
                    
                    <div class="option-card">
                        <h4>Redistribución Inteligente</h4>
                        <p>Redistribuir presupuestos basado en utilización histórica</p>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="smart-redistribution">
                                <span class="checkmark"></span>
                                Activar redistribución automática
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeBulkUpdateModal()">Cancelar</button>
                <button class="btn-primary" onclick="executeBulkUpdate()">Aplicar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Loading and Notifications -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Procesando presupuestos...</span>
        </div>
    </div>

    <!-- Hidden input for Import -->
    <input type="file" id="import-file" accept=".csv,.json" style="display:none" />

    <!-- Scripts -->
    <!-- Reemplazo: usar bundle local para evitar bloqueo del CDN -->
    <script src="/vendor/chartjs/chart.min.js"></script>
    <script src="js/budgets-advanced.js"></script>
</body>
</html>
